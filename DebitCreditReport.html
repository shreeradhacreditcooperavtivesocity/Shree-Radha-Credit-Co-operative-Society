<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRCCS ‚Äî Ultra Pro Auto Balance Sheet</title>

<style>
/* =========================================================
   HDFC / ICICI PREMIUM BANKING UI
   ONLY CSS ‚Äî HTML & JS SAME
========================================================= */

:root{
  --primary:#003a8f;          /* ICICI / HDFC Deep Blue */
  --primary-dark:#002b6b;
  --accent:#c62828;           /* HDFC Red */
  --bg:#f2f5f9;
  --card:#ffffff;
  --border:#dde3ec;
  --text:#1f2937;
  --muted:#6b7280;
  --success:#15803d;
  --danger:#b91c1c;
}

/* ================= RESET ================= */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:"Segoe UI","Inter","Noto Sans Devanagari",system-ui,sans-serif;
}

body{
  background:linear-gradient(180deg,#eef3f9,#f7f9fc);
  color:var(--text);
  padding:20px;
}

/* ================= CONTAINER ================= */
.container{
  max-width:1200px;
  margin:auto;
}

/* ================= HEADER ================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:linear-gradient(90deg,#ffffff,#f5f8fd);
  padding:18px 22px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.05);
}

.title h1{
  font-size:20px;
  font-weight:700;
  color:var(--primary);
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:5px 12px;
  font-size:11px;
  background:#e9f0fb;
  color:var(--primary);
  border-radius:999px;
  border:1px solid var(--border);
  font-weight:600;
}

.badge-dot{
  width:7px;
  height:7px;
  border-radius:50%;
  background:var(--accent);
}

.last-update{
  font-size:12px;
  color:var(--muted);
}

/* ================= MAIN CARD ================= */
.main-card{
  background:var(--card);
  border-radius:16px;
  padding:18px;
  border:1px solid var(--border);
  box-shadow:0 10px 28px rgba(0,0,0,.06);
}

/* ================= SUMMARY ================= */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:14px;
}

.card-small{
  background:linear-gradient(180deg,#ffffff,#f9fbff);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
}

.label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.08em;
  font-weight:600;
}

.value{
  font-size:24px;
  font-weight:700;
  margin-top:6px;
  color:var(--primary);
}

/* ================= SECTION ================= */
.section-title{
  margin:16px 0 8px;
  font-size:13px;
  font-weight:700;
  color:#374151;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ================= PANEL ================= */
.panel{
  background:#ffffff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}

/* ================= TABLE ================= */
.table-wrapper{
  max-height:340px;
  overflow:auto;
  border-radius:10px;
  border:1px solid var(--border);
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

thead{
  background:linear-gradient(180deg,#f1f5fb,#e9eef6);
  position:sticky;
  top:0;
  z-index:5;
}

th{
  text-align:left;
  font-weight:700;
  color:#374151;
}

th,td{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
}

tbody tr:nth-child(even){
  background:#fafcff;
}

tbody tr:hover{
  background:#eef5ff;
}

/* ================= BADGES ================= */
.badge-active{
  background:#e8f7ee;
  color:var(--success);
  padding:4px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
}

.badge-inactive{
  background:#fdecec;
  color:var(--danger);
  padding:4px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
}

.badge-loan{
  background:#fff3d6;
  color:#b45309;
  padding:4px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
}

.badge-no{
  background:#eef2f7;
  color:#6b7280;
  padding:4px 12px;
  border-radius:999px;
}

/* ================= LINKS ================= */
.account-link{
  color:var(--primary);
  font-weight:700;
  cursor:pointer;
  text-decoration:none;
}
.account-link:hover{
  text-decoration:underline;
}

/* ================= INPUTS ================= */
.input,select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  font-size:13px;
}

.input:focus,select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(0,58,143,.15);
}

/* ================= BUTTON ================= */
.btn{
  margin-top:14px;
  padding:11px 22px;
  background:linear-gradient(180deg,var(--primary),var(--primary-dark));
  color:#fff;
  border:none;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 6px 14px rgba(0,58,143,.35);
}

.btn:hover{
  filter:brightness(1.05);
}

/* ================= AGENT BOX ================= */
.agent-box{
  background:#ffffff;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}

.agent-row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
}

.agent-label{
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
  font-weight:600;
}

.agent-msg{
  margin-top:6px;
  font-size:12px;
}

.success{color:var(--success)}
.error{color:var(--danger)}

/* ================= MODAL ================= */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-box{
  background:#ffffff;
  padding:18px;
  width:660px;
  max-height:90vh;
  overflow:auto;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:0 20px 40px rgba(0,0,0,.25);
}

.modal-close{
  background:#f1f5f9;
  border:1px solid var(--border);
  width:30px;
  height:30px;
  border-radius:50%;
  cursor:pointer;
}


</style>
</head>
<body>
  <div class="container">

    <!-- HEADER -->
    <div class="header">
      <div class="title">
        <div class="badge"><span class="badge-dot"></span> SRCCS ‚Ä¢ Live Auto Balance Sheet</div>
        <h1>Shree Radha Credit Co-operative Society</h1>
        <div class="subtitle" style="font-size:13px;color:var(--muted);margin-top:6px">Accounts ¬∑ Agent Entry ¬∑ Loans ¬∑ Reports</div>
      </div>
      <div style="text-align:right">
        <div id="lastUpdatedText" class="last-update">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        <div style="margin-top:6px"><button class="pill" id="btnRefresh">Refresh</button></div>
      </div>
    </div>

    <!-- MAIN CARD -->
    <div class="main-card">

      <!-- SUMMARY -->
      <div class="summary" style="margin-bottom:12px">
        <div class="card-small">
          <div class="label">‡§∏‡§Æ‡§ø‡§§‡§ø ‡§ï‡§æ ‡§ï‡•Å‡§≤ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏</div>
          <div id="totalBalance" class="value">‚Çπ 0</div>
        </div>
        <div class="card-small">
          <div class="label">‡§ï‡•Å‡§≤ Loan Outstanding</div>
          <div id="totalLoanOutstanding" class="value">‚Çπ 0</div>
        </div>
        <div class="card-small">
          <div class="label">Net Position</div>
          <div id="netPosition" class="value">‚Çπ 0</div>
        </div>
        <div class="card-small">
          <div class="label">‡§Ü‡§ú ‡§ï‡•Ä ‡§ú‡§Æ‡§æ / ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä</div>
          <div class="value"><span id="todayCredit">‚Çπ 0</span> / <span id="todayDebit">‚Çπ 0</span></div>
        </div>
      </div>

      <!-- MAIN GRID -->
      <div style="display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start">

        <!-- LEFT: Accounts + Table -->
        <div>
          <div class="section-title">
            <div style="display:flex;gap:8px;align-items:center">
              <input id="searchAccount" class="input" placeholder="Search account or name..." style="width:320px"/>
              <button class="refresh-btn" id="miniRefresh">üîÑ</button>
            </div>
            <div id="accountsSummary"></div>
          </div>

          <div class="panel">
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr><th>Account</th><th>Created</th><th>Balance</th><th>Last Payment</th><th>Type</th><th>Status</th><th>Loan</th></tr>
                </thead>
                <tbody id="accountsTableBody">
                  <tr><td colspan="7">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- RIGHT: Agent Entry + Quick Stats -->
        <div>
          <div class="section-title"><span>üíº Agent Entry</span> <span id="agentClock" style="font-size:12px;color:var(--muted)"></span></div>

          <div class="agent-box">
            <div class="agent-row">
              <div>
                <div class="agent-label">Account (last 4 digits)</div>
                <input id="aAccount" class="input" placeholder="e.g. 3578" maxlength="4" />
              </div>
              <div>
                <div class="agent-label">Amount (‚Çπ)</div>
                <input id="aAmount" class="input" type="number" placeholder="Amount" />
              </div>
              <div>
                <div class="agent-label">Type</div>
                <select id="aType" class="input">
                  <option value="">Select</option>
                  <option value="credit">Credit</option>
                  <option value="debit">Debit</option>
                </select>
              </div>
              <div>
                <div class="agent-label">Agent ID</div>
                <select id="aID" class="input">
                  <option value="">Select</option>
                  <option value="SH7333">SH7333</option>
                  <option value="KA4564">KA4564</option>
                  <option value="JE2659">JE2659</option>
                  <option value="SRCCS1432">SRCCS1432</option>
                  <option value="CHARGE">CHARGE</option>
                  <option value="LOAN EMI">LOAN EMI</option>
                </select>
              </div>
            </div>

            <button class="btn" id="agentSubmit">üíæ Submit</button>
            <div id="agentMsg" class="agent-msg"></div>
          </div>

          <div style="height:12px"></div>

          <div class="panel" style="padding:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="label">Today Totals</div>
                <div style="font-weight:700;font-size:16px;margin-top:6px"><span id="miniTodayCredit">‚Çπ 0</span> / <span id="miniTodayDebit">‚Çπ 0</span></div>
              </div>
              <div style="text-align:right">
                <div class="label">Loans</div>
                <div id="miniLoanCount" style="font-weight:700;font-size:16px;margin-top:6px">0</div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="footer-note">* Read-Only Dashboard ‚Äî Data Google Sheets ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§π‡•à‡•§</div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="customerModal" class="modal-overlay">
    <div class="modal-box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div class="badge"><span class="badge-dot"></span> Details</div>
        <button class="modal-close" onclick="closeCustomerModal()">√ó</button>
      </div>
      <div id="modalContent" style="color:#ddd;font-size:13px">Loading...</div>
    </div>
  </div>

<script>
/* --------------------------
   CONFIG (replace if needed)
---------------------------*/
const ACCOUNT_API_URL  = "https://script.google.com/macros/s/AKfycbw2TxBUYHne2uZ7JiI71ly8hctmpj-dXkMu3rCeEXalm7fCU_GQOxGpFO6ik-HRdNwB/exec";
const LOAN_API_URL     = "https://script.google.com/macros/s/AKfycbxo7Q9PoAPWtdrLtQIR_uweA5A3j9AUSlyp3Hbzk7IKorOHDpW-UIfLXWbb0jWwNVBx1g/exec";
const CUSTOMER_API_URL = "https://script.google.com/macros/s/AKfycbxm_Fmpn-Oaa9tNOiPBXVEqmUK_cZQyMkYNBEd0kUTNvvEQtp25BOBDkeppg0ZqrMtF/exec";
const AGENT_API_URL    = "https://script.google.com/macros/s/AKfycbyNgpjiGxsdawUqPPVwsclM0x3AOlFPSK-VsgpH937HLf4A7XrhuncW8M0F0UcNKWmT/exec";

/* UTILS */
function formatINR(n){ if(n==null||n==undefined) return "0"; return Number(n).toLocaleString('en-IN'); }
function toRupee(n){ return "‚Çπ "+formatINR(n); }

/* MODAL */
function openCustomerModal(){ document.getElementById("customerModal").style.display="flex"; }
function closeCustomerModal(){ document.getElementById("customerModal").style.display="none"; }

/* AGENT CLOCK */
setInterval(()=> {
  document.getElementById("agentClock").textContent = new Date().toLocaleTimeString('en-IN',{hour12:true});
},1000);

/* GLOBAL CACHE */
let LOANS_CACHE = [];
let LAST_TX_CACHE = {}; // cache transactions per account

/* LOAD LOANS */
async function loadLoanSummary(){
  try{
    const res = await fetch(LOAN_API_URL + "?action=getLoans");
    const data = await res.json();
    LOANS_CACHE = data || [];

    let totalOut = 0;
    const set = new Set();

    LOANS_CACHE.forEach(l=>{
      totalOut += Number(l.Outstanding)||0;
      const acc = l.Account || l["Account No"] || "";
      if(acc) set.add(String(acc).trim());
    });

    document.getElementById("totalLoanOutstanding").textContent = toRupee(totalOut);
    document.getElementById("miniLoanCount").textContent = LOANS_CACHE.length||0;

    return { totalOutstanding: totalOut, loanAccountsSet: set };
  }catch(e){
    console.error("loadLoanSummary:",e);
    return { totalOutstanding:0, loanAccountsSet:new Set() };
  }
}

/* LOAD ACCOUNTS */
async function loadAccountSummary(loanSet){
  try{
    const todayRes = await fetch(ACCOUNT_API_URL + "?fn=getTodayTotals");
    const today = await todayRes.json();

    document.getElementById("todayCredit").textContent = toRupee(today.creditToday);
    document.getElementById("todayDebit").textContent  = toRupee(today.debitToday);
    document.getElementById("totalBalance").textContent = toRupee(today.totalBalance || 0);
    document.getElementById("miniTodayCredit").textContent = toRupee(today.creditToday);
    document.getElementById("miniTodayDebit").textContent = toRupee(today.debitToday);

    // accounts list
    const accRes = await fetch(ACCOUNT_API_URL + "?fn=getAccountsStatus&days=90");
    const acc = await accRes.json();

    const tbody = document.getElementById("accountsTableBody");
    const top = document.getElementById("accountsSummary");
    tbody.innerHTML = "";
    top.innerHTML = "";

    let loanCount=0;
    (acc.accounts||[]).forEach(a=>{
      const id = a.account || a.accountNo || "";
      const hasLoan = loanSet.has(String(id).trim());
      if(hasLoan) loanCount++;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="account-link" onclick="showAccountTransactions('${id}')">${id}</span></td>
        <td>${a.createdDate||"-"}</td>
        <td>‚Çπ ${formatINR(a.balance)}</td>
        <td>${a.lastPaymentDate||"-"}</td>
        <td>${a.lastPaymentType||"-"}</td>
        <td><span class="${a.active ? 'badge-active customer-badge' : 'badge-inactive customer-badge'}" data-acc="${id}">${a.active ? 'Active' : 'Inactive'}</span></td>
        <td>${hasLoan ? `<span class="badge-loan loan-badge" data-acc="${id}">Loan</span>` : `<span class="badge-no">No</span>` }</td>
      `;
      tbody.appendChild(tr);
    });

    top.innerHTML = `
      <span class="pill">Total: ${acc.total||0}</span>
      <span class="pill">Active: ${acc.activeCount||0}</span>
      <span class="pill">Inactive: ${acc.inactiveCount||0}</span>
      <span class="pill">Loan Accounts: ${loanCount}</span>
    `;

    // attach handlers
    document.querySelectorAll(".customer-badge").forEach(x => x.onclick = ()=> showCustomerDetails(x.dataset.acc));
    document.querySelectorAll(".loan-badge").forEach(x => x.onclick = ()=> showLoanDetails(x.dataset.acc));

    return today.totalBalance || 0;

  }catch(e){
    console.error("loadAccountSummary:", e);
    return 0;
  }
}

/* SHOW CUSTOMER DETAILS (Modal) */
async function showCustomerDetails(acc){
  openCustomerModal();
  document.getElementById("modalContent").innerHTML = "Loading...";
  try{
    const r = await fetch(CUSTOMER_API_URL + "?action=fetchOne&accountNumber=" + encodeURIComponent(acc));
    const data = await r.json();
    if(!data.record){
      document.getElementById("modalContent").innerHTML = "Not Found!";
      return;
    }
    const rcd = data.record;
    document.getElementById("modalContent").innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">${rcd.name || '-'}</div>
      <div><b>Account:</b> ${rcd.accountNumber || '-'}</div>
      <div><b>Aadhaar:</b> ${rcd.aadhaar || '-'}</div>
      <div><b>Mobile:</b> ${rcd.mobile || '-'}</div>
      <div><b>Address:</b> ${rcd.address || '-'}</div>
      <div style="margin-top:8px"><button class="modal-button btn-print" onclick="printCustomer('${rcd.accountNumber||''}')">Print</button></div>
    `;
  }catch(e){
    console.error(e);
    document.getElementById("modalContent").innerHTML = "Error loading customer";
  }
}

/* FIND LOAN BY ACCOUNT */
function findLoanByAccount(acc){
  if(!LOANS_CACHE) return null;
  return LOANS_CACHE.find(l => String(l.Account).trim() === String(acc).trim() || String(l["Account No"]||"").trim() === String(acc).trim());
}

/* SHOW LOAN DETAILS (Modal) */
function showLoanDetails(acc){
  const loan = findLoanByAccount(acc);
  openCustomerModal();
  if(!loan){
    document.getElementById("modalContent").innerHTML = "Loan Not Found!";
    return;
  }
  let history=[];
  try{ history = JSON.parse(loan["EMI History"]||"[]"); }catch(e){ history=[]; }

  let histHTML = history.length ? history.map(h=>`<div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.04)"><b>${h.date}</b> ‚Äî ‚Çπ${formatINR(h.amount)} (${h.type||'emi'})</div>`).join("") : "No EMI History";

  const todayStr = new Date().toISOString().slice(0,10);

  document.getElementById("modalContent").innerHTML = `
    <div style="font-weight:700;margin-bottom:6px">${loan.Name || '‚Äî'}</div>
    <div><b>Loan ID:</b> ${loan["Loan ID"]}</div>
    <div><b>Account:</b> ${loan.Account}</div>
    <div><b>Principal:</b> ‚Çπ${formatINR(loan.Principal)}</div>
    <div><b>Outstanding:</b> ‚Çπ${formatINR(loan.Outstanding)}</div>
    <div><b>EMI:</b> ‚Çπ${formatINR(loan.EMI)}</div>
    <div style="margin-top:8px">
      <div style="margin-bottom:6px"><b>Pay EMI</b></div>
      <input id="emiAmount" class="modal-input" type="number" value="${loan.EMI || ''}" placeholder="EMI Amount">
      <input id="emiDate" class="modal-input" type="date" value="${todayStr}">
      <div style="margin-top:6px">
        <button class="modal-button btn-emi" onclick="submitEmiPayment('${loan["Loan ID"]}')">Pay EMI</button>
        <button class="modal-button btn-print" onclick="printLoanSummary('${loan["Loan ID"]}')">Print Slip</button>
      </div>
    </div>

    <hr style="margin:10px 0;border-color:#3b4756;">

    <div style="font-weight:600;margin-bottom:6px">EMI History</div>
    <div style="max-height:180px;overflow:auto">${histHTML}</div>
  `;
}

/* SHOW ACCOUNT TRANSACTIONS (last 10 days) & PDF DOWNLOAD */
async function showAccountTransactions(acc){
  openCustomerModal();
  const content = document.getElementById("modalContent");
  content.innerHTML = `Loading transactions for <b>${acc}</b> ...`;

  try{
    // fetch last 10 days transactions
    const res = await fetch(ACCOUNT_API_URL + "?fn=getTransactions&account=" + encodeURIComponent(acc) + "&days=10");
    const data = await res.json();
    // Expect data.transactions = [{date,type,amount,remarks,txnId}, ...]
    const tx = data.transactions || data.txns || [];

    // cache for quick filtering/printing
    LAST_TX_CACHE[acc] = tx;

    // build modal html
    let rowsHTML = '';
    if(tx.length === 0){
      rowsHTML = '<div style="padding:8px;color:var(--muted)">‡§ï‡•ã‡§à ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (Last 10 days)</div>';
    }else{
      rowsHTML = tx.map(t => {
        return `<div class="tx-row">
                  <div class="left">
                    <div style="min-width:120px"><b>${t.date || t.txnDate || '-'}</b></div>
                    <div style="min-width:120px">${t.remarks || t.description || ''}</div>
                  </div>
                  <div class="right">
                    <div class="amt">${t.type && t.type.toLowerCase()==='credit' ? '+' : '-'} ‚Çπ ${formatINR(t.amount)}</div>
                    <div style="font-size:11px;color:var(--muted);margin-top:6px">${t.txnId || ''}</div>
                  </div>
                </div>`;
      }).join('');
    }

    const today = new Date().toISOString().slice(0,10);

    content.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">Account: ${acc}</div>

      <div class="modal-controls">
        <button class="btn-secondary" onclick="renderTxList('${acc}')">Show Last 10 Days</button>
        <label style="font-size:13px;color:var(--muted)">Select date:</label>
        <input class="input-date" id="filterDate" type="date" max="${today}" />
        <button class="btn" onclick="downloadPdfForDate('${acc}')">üìÑ Download PDF for Date</button>
        <button class="btn-secondary" onclick="printTxWindow('${acc}')">üñ®Ô∏è Print All (10 days)</button>
      </div>

      <div id="txListContainer" class="tx-list">${rowsHTML}</div>
    `;

  }catch(e){
    console.error("showAccountTransactions:", e);
    content.innerHTML = "Error loading transactions.";
  }
}

/* render tx list from cache */
function renderTxList(acc){
  const tx = LAST_TX_CACHE[acc] || [];
  const container = document.getElementById("txListContainer");
  if(!container) return;
  if(tx.length===0){
    container.innerHTML = '<div style="padding:8px;color:var(--muted)">No transactions in last 10 days</div>';
    return;
  }
  container.innerHTML = tx.map(t => {
    return `<div class="tx-row">
              <div class="left">
                <div style="min-width:120px"><b>${t.date || t.txnDate || '-'}</b></div>
                <div style="min-width:120px">${t.remarks || t.description || ''}</div>
              </div>
              <div class="right">
                <div class="amt">${t.type && t.type.toLowerCase()==='credit' ? '+' : '-'} ‚Çπ ${formatINR(t.amount)}</div>
                <div style="font-size:11px;color:var(--muted);margin-top:6px">${t.txnId || ''}</div>
              </div>
            </div>`;
  }).join('');
}

/* Print/Download helpers */

/* Print entire 10-day transactions in a new window (user can Save as PDF) */
function printTxWindow(acc){
  const tx = LAST_TX_CACHE[acc] || [];
  const w = window.open('','_blank');
  const title = `Transactions_${acc}`;
  const now = new Date().toLocaleString('en-IN');
  let rows = '';
  if(tx.length===0){
    rows = `<tr><td colspan="4">No transactions in last 10 days</td></tr>`;
  }else{
    rows = tx.map(t => {
      const date = t.date || t.txnDate || '';
      const type = t.type || '';
      const amt = formatINR(t.amount || 0);
      const desc = (t.remarks || t.description || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const id = t.txnId || '';
      return `<tr style="border-bottom:1px solid #ddd"><td>${date}</td><td>${desc}</td><td style="text-align:right">${type}</td><td style="text-align:right">‚Çπ ${amt}</td></tr>`;
    }).join('');
  }

  const html = `
    <html><head><meta charset="utf-8"><title>${title}</title>
      <style>
        body{font-family:Arial;padding:18px;color:#111}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:8px}
        th{background:#f5f5f5}
      </style>
    </head>
    <body>
      <h2>Shree Radha Credit Co-operative Society</h2>
      <div>Account: <b>${acc}</b></div>
      <div>Printed: ${now}</div>
      <hr>
      <table>
        <thead><tr><th>Date</th><th>Description</th><th>Type</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>Prepared By</div><div>Checked By</div>
      </div>
    </body></html>
  `;
  w.document.write(html);
  w.document.close();
  w.focus();
  // let user choose Save as PDF via print dialog
  setTimeout(()=> w.print(), 500);
}

/* Download PDF for specific date: filter cached tx and print that subset */
function downloadPdfForDate(acc){
  const date = document.getElementById("filterDate").value;
  if(!date){
    alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§ö‡•Å‡§®‡•á‡§Ç (Select a date)");
    return;
  }
  const tx = (LAST_TX_CACHE[acc] || []).filter(t => {
    const tdate = (t.date || t.txnDate || '').slice(0,10);
    return tdate === date;
  });

  const w = window.open('','_blank');
  const title = `Transactions_${acc}_${date}`;
  const now = new Date().toLocaleString('en-IN');

  let rows = '';
  if(tx.length===0){
    rows = `<tr><td colspan="4">No transactions on ${date}</td></tr>`;
  }else{
    rows = tx.map(t => {
      const d = t.date || t.txnDate || '';
      const type = t.type || '';
      const amt = formatINR(t.amount || 0);
      const desc = (t.remarks || t.description || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const id = t.txnId || '';
      return `<tr style="border-bottom:1px solid #ddd"><td>${d}</td><td>${desc}</td><td style="text-align:right">${type}</td><td style="text-align:right">‚Çπ ${amt}</td></tr>`;
    }).join('');
  }

  const html = `
    <html><head><meta charset="utf-8"><title>${title}</title>
      <style>
        body{font-family:Arial;padding:18px;color:#111}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:8px}
        th{background:#f5f5f5}
      </style>
    </head>
    <body>
      <h2>Shree Radha Credit Co-operative Society</h2>
      <div>Account: <b>${acc}</b></div>
      <div>Date: <b>${date}</b></div>
      <div>Printed: ${now}</div>
      <hr>
      <table>
        <thead><tr><th>Date & Time</th><th>Description</th><th style="text-align:right">Type</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>Prepared By</div><div>Checked By</div>
      </div>
    </body></html>
  `;
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(()=> w.print(), 500);
}

/* SUBMIT EMI PAYMENT */
async function submitEmiPayment(loanId){
  const amt = document.getElementById("emiAmount").value;
  const dt  = document.getElementById("emiDate").value;
  if(!amt || !dt){ alert("Amount and Date required"); return; }

  try{
    const r = await fetch(LOAN_API_URL, { method:'POST', body: JSON.stringify({ action:'payEmi', loanId, amount:amt, date:dt }) });
    const res = await r.json();
    if(res.status === "success"){ alert("EMI Paid"); await refreshAll(); closeCustomerModal(); }
    else alert("Error: "+(res.message||''));
  }catch(e){
    console.error(e);
    alert("Error while paying EMI");
  }
}

/* PRINT FUNCTIONS (customer/loan kept as before) */
function printCustomer(acc){
  const w = window.open('','_blank');
  w.document.write(`<html><head><meta charset="utf-8"><title>Customer ${acc}</title></head><body><h2>Customer: ${acc}</h2><p>Details printed from SRCCS</p></body></html>`);
  w.document.close(); w.print();
}

function printLoanSummary(loanId){
  const loan = LOANS_CACHE.find(l=>String(l["Loan ID"])===String(loanId));
  if(!loan){ alert("Loan not found"); return; }
  const w = window.open('','_blank');
  const today = new Date().toLocaleString('en-IN');
  const html = `
    <html><head><meta charset="utf-8"><title>Loan Slip</title></head>
    <body style="font-family:Arial;padding:18px">
      <h2>Shree Radha Credit Co-operative Society</h2>
      <div style="margin-top:6px">Loan Slip</div>
      <hr>
      <table style="width:100%;font-size:13px">
        <tr><td><b>Date</b></td><td style="text-align:right">${today}</td></tr>
        <tr><td><b>Loan ID</b></td><td style="text-align:right">${loan["Loan ID"]}</td></tr>
        <tr><td><b>Name</b></td><td style="text-align:right">${loan.Name}</td></tr>
        <tr><td><b>Account</b></td><td style="text-align:right">${loan.Account}</td></tr>
        <tr><td><b>Outstanding</b></td><td style="text-align:right">‚Çπ${formatINR(loan.Outstanding)}</td></tr>
      </table>
      <div style="margin-top:40px;display:flex;justify-content:space-between">
        <div>Borrower Signature</div><div>Manager Signature</div>
      </div>
    </body></html>
  `;
  w.document.write(html); w.document.close(); w.print();
}

/* AGENT TRANSACTION SAVE */
async function saveAgentTransaction(){
  let acc = document.getElementById("aAccount").value.trim();
  const amt = document.getElementById("aAmount").value;
  const type = document.getElementById("aType").value;
  const id = document.getElementById("aID").value;
  const msg = document.getElementById("agentMsg");

  if(!acc || acc.length !== 4){ alert("Enter last 4 digits of account"); return; }
  if(acc.toUpperCase().startsWith("SRC")) acc = acc.substring(3);
  const account = "SRC" + acc;

  if(!amt || !type || !id){ alert("Fill all fields"); return; }

  try{
    const r = await fetch(AGENT_API_URL, { method:'POST', body: JSON.stringify({ fn:'transaction', account, amount:amt, type, agent:id }) });
    const data = await r.json();
    msg.textContent = data.message || "Saved";
    msg.className = "agent-msg success";

    // reset
    document.getElementById("aAccount").value = "";
    document.getElementById("aAmount").value = "";
    document.getElementById("aType").value = "";
    document.getElementById("aID").value = "";
    document.getElementById("aAccount").focus();

    await refreshAll();

  }catch(e){
    console.error("saveAgentTransaction:",e);
    msg.textContent = "Error";
    msg.className = "agent-msg error";
  }

  setTimeout(()=>{ msg.textContent = ""; msg.className = "agent-msg"; }, 3000);
}

/* REFRESH ALL DATA */
async function loadDashboard(){
  document.getElementById("lastUpdatedText").textContent = "Loading...";
  const loan = await loadLoanSummary();
  const accBal = await loadAccountSummary(loan.loanAccountsSet);
  const net = Number(accBal) - Number(loan.totalOutstanding || 0);
  document.getElementById("netPosition").textContent = toRupee(net);
  document.getElementById("lastUpdatedText").textContent = "Last Update: " + new Date().toLocaleString('en-IN');
}

async function refreshAll(){
  await loadDashboard();
}

/* SEARCH FILTER */
document.getElementById("searchAccount").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  const rows = document.querySelectorAll("#accountsTableBody tr");
  rows.forEach(r=>{ const text = r.textContent.toLowerCase(); r.style.display = text.includes(q) ? "" : "none"; });
});

/* BUTTON HOOKS */
document.getElementById("btnRefresh").addEventListener("click", loadDashboard);
document.getElementById("miniRefresh").addEventListener("click", loadDashboard);
document.getElementById("agentSubmit").addEventListener("click", saveAgentTransaction);

/* INIT */
loadDashboard();

/* Close modal on overlay click */
document.getElementById("customerModal").addEventListener("click", function(e){
  if(e.target === this) closeCustomerModal();
});
</script>
</body>
</html>
