<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loan Dashboard — Shree Radha Credit Co-operative Society</title>
<style>
:root{--maroon:#800000;--light:#a55252;--paper:#fff;--muted:#666}
*{box-sizing:border-box}
body{font-family:Inter, system-ui, Arial; margin:0; background:#f6f7fb; color:#222}
header{background:linear-gradient(90deg,var(--maroon),var(--light)); color:white; padding:18px 20px}
.wrap{max-width:1200px;margin:18px auto;padding:18px}
.card{background:var(--paper);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:16px;margin-bottom:16px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
button{background:var(--maroon);color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
.muted{color:var(--muted);font-size:13px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left;font-size:14px}
th{background:#fafafa}
.top-buttons{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.toggle-card{display:none;margin-bottom:16px}
.alert-box{background:#ffe4e1;color:#800000;padding:10px 14px;border-radius:8px;margin-bottom:10px;font-weight:600;border:1px solid #f5c2c2;cursor:pointer}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:8px;max-width:800px;width:95%;max-height:80%;overflow:auto;position:relative}
.modal-close{position:absolute;top:8px;right:12px;font-size:20px;font-weight:bold;cursor:pointer}
@media(max-width:900px){.top-buttons{flex-direction:column}}
@media print{
  body *{visibility:hidden}
  .print-area, .print-area *{visibility:visible}
  .print-area{position:fixed;left:0;top:0;width:100%}
}
</style>
</head>
<body>
<header>
  <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1 style="margin:0;font-size:18px">Shree Radha Credit Co-operative Society</h1>
      <div style="font-size:13px;opacity:0.95">Loan Dashboard — Reg. No: DR/DHR/151716</div>
    </div>
    <div style="font-size:13px;opacity:0.95">मेन्यू: Loan Register · Loan List · Reports</div>
  </div>
</header>

<main class="wrap">

<div id="alertArea"></div>

<!-- Loan Summary -->
<div id="loanSummary" class="card">
  <h3>Loan Summary</h3>
  <div style="display:flex;gap:20px;flex-wrap:wrap">
    <div><strong>Total Loans:</strong> <span id="totalLoans">0</span></div>
    <div><strong>Active Loans:</strong> <span id="activeLoans">0</span></div>
    <div><strong>Total Principal:</strong> <span id="totalPrincipal">₹0</span></div>
    <div><strong>Total Paid EMI:</strong> <span id="totalPaid">₹0</span></div>
    <div><strong>Total Outstanding:</strong> <span id="totalOutstanding">₹0</span></div>
  </div>
</div>

<!-- Top Buttons -->
<div class="top-buttons">
  <button onclick="toggleForm('loanFormCard')">नया लोन</button>
  <button onclick="toggleForm('emiFormCard')">EMI Payment</button>
  <button onclick="toggleForm('penaltyFormCard')">Penalty Entry</button>
</div>

<!-- Forms -->
<div id="loanFormCard" class="card toggle-card">
  <h3>नया लोन दर्ज करें</h3>
  <form id="loanForm" onsubmit="return false">
    <label>Loan ID</label><input id="loanId" required />
    <label>नाम</label><input id="name" required />
    <label>खाता नंबर</label><input id="account" required />
    <label>लोन राशि (₹)</label><input id="principal" type="number" min="0" required />
    <label>सालाना ब्याज दर (%)</label><input id="rate" type="number" step="0.01" min="0" value="12" required />
    <label>अवधि (महीनों में)</label><input id="tenure" type="number" min="1" value="12" required />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="calcBtn" type="button">EMI Calculate</button>
      <button id="addLoan" type="button">Add/Update Loan</button>
    </div>
    <div style="margin-top:10px">
      <div class="muted">Calculated EMI</div>
      <div id="emiResult" style="font-weight:700;font-size:16px">—</div>
    </div>
  </form>
</div>

<div id="emiFormCard" class="card toggle-card">
  <h3>EMI Payment</h3>
  <form id="emiForm" onsubmit="return false">
    <label>Loan ID</label><input id="emiLoanId" required />
    <label>Paid EMI (₹)</label><input id="emiAmount" type="number" min="0" required />
    <label>Payment Date</label><input id="emiDate" type="date" value="" required />
    <button id="payEmi" type="button">Submit EMI Payment</button>
  </form>
</div>

<div id="penaltyFormCard" class="card toggle-card">
  <h3>Penalty Entry</h3>
  <form id="penaltyForm" onsubmit="return false">
    <label>Loan ID</label><input id="penaltyLoanId" required />
    <label>Penalty (₹)</label><input id="penaltyAmount" type="number" min="0" required />
    <label>Payment Date</label><input id="penaltyDate" type="date" value="" required />
    <button id="addPenalty" type="button">Add Penalty</button>
  </form>
</div>

<!-- Loan List -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h2 style="margin:0;font-size:16px">Loan Register & List</h2>
    <input id="search" placeholder="खोज: नाम / खाता नंबर / लोन आईडी" style="width:250px;padding:8px;border-radius:8px;border:1px solid #ddd" />
  </div>
  <table>
    <thead>
      <tr><th>Loan ID</th><th>Name</th><th>Account</th><th>Principal</th><th>Rate%</th><th>Tenure</th><th>EMI</th><th>Paid EMI</th><th>Penalty</th><th>Outstanding</th><th>Action</th></tr>
    </thead>
    <tbody id="loansTbody"></tbody>
  </table>
</div>

<!-- EMI History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content print-area">
    <span class="modal-close" onclick="closeModal()">×</span>
    <h3>EMI History & Schedule</h3>
    <div><strong>Loan ID:</strong> <span id="modalLoanId"></span> &nbsp; <strong>Name:</strong> <span id="modalName"></span></div>
    <table id="historyTable" style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th>Month</th>
          <th>Due Date</th>
          <th>EMI Amount (₹)</th>
          <th>Paid (₹)</th>
          <th>Penalty (₹)</th>
          <th>Outstanding (₹)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbyh7hCU6r6B36nxusfYri9cENVmPqv_lnyIGv-5pwK33bJE_CPcAZXpH1YcLCHdugm7dg/exec"; // Replace with your Apps Script URL
let loans=[];

function toggleForm(id){ const el=document.getElementById(id); el.style.display=el.style.display==='block'?'none':'block'; }
function rupee(x){return '₹'+Number(x).toLocaleString('en-IN')}
function calcEMI(P,r,n){P=Number(P);r=Number(r)/100/12;n=Number(n);return r===0? P/n: (P*r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1)}

async function fetchLoans(){
  try{
    const res=await fetch(WEB_APP_URL+'?action=getLoans');
    const data=await res.json();
    loans=data.map(l=>({...l,"EMI History":l["EMI History"]||'[]'}));
    refreshList();
    showUpcomingAlerts();
  }catch(err){console.error(err);}
}

function showUpcomingAlerts(){
  const alertDiv=document.getElementById('alertArea');
  alertDiv.innerHTML='';
  const today=new Date();
  loans.forEach(l=>{
    const start=new Date(l.StartDate);
    for(let i=0;i<l.Tenure;i++){
      const due=new Date(start); due.setMonth(start.getMonth()+i);
      const diff=(due-today)/(1000*60*60*24);
      if(diff>0 && diff<=3){
        const d=document.createElement('div');
        d.className='alert-box';
        d.innerText=`⚠️ ${l.Name} की EMI ${due.toISOString().split('T')[0]} को देय है।`;
        d.onclick=()=>openEMIModal(l);
        alertDiv.appendChild(d);
      }
    }
  });
}

function refreshList(filter=''){
  const tbody=document.getElementById('loansTbody'); 
  tbody.innerHTML='';
  const q=filter.trim().toLowerCase();

  let totalLoans = 0, activeLoans = 0, totalPrincipal = 0, totalPaid = 0, totalOutstanding = 0;

  loans.forEach((l,idx)=>{
    const text=[l["Loan ID"],l["Name"],l["Account"]].join(' ').toLowerCase();
    if(q && !text.includes(q)) return;

    totalLoans++;
    totalPrincipal += Number(l.Principal);
    totalPaid += Number(l["Paid EMI"]);
    totalOutstanding += Number(l.Outstanding);
    if(Number(l.Outstanding) > 0) activeLoans++;

    const tr=document.createElement('tr');
    // Completed loans text clickable for details
    let actionCell = `<button class="view" data-idx="${idx}">View</button>`;
    if(Number(l.Outstanding) <= 0){
        actionCell = `<span style="color:green;font-weight:600;cursor:pointer" class="view" data-idx="${idx}">Successfully Completed</span>`;
    }

    tr.innerHTML=`<td>${l["Loan ID"]}</td>
      <td>${l["Name"]}</td>
      <td>${l["Account"]}</td>
      <td>${rupee(l["Principal"])}</td>
      <td>${l["Rate"]}</td>
      <td>${l["Tenure"]}</td>
      <td>${rupee(l["EMI"])}</td>
      <td>${rupee(l["Paid EMI"])}</td>
      <td>${rupee(l["Penalty"])}</td>
      <td>${rupee(l["Outstanding"])}</td>
      <td>${actionCell}</td>`;
    tbody.appendChild(tr);
  });

  // Update summary
  document.getElementById('totalLoans').innerText = totalLoans;
  document.getElementById('activeLoans').innerText = activeLoans;
  document.getElementById('totalPrincipal').innerText = rupee(totalPrincipal);
  document.getElementById('totalPaid').innerText = rupee(totalPaid);
  document.getElementById('totalOutstanding').innerText = rupee(totalOutstanding);
}

document.getElementById('loansTbody').addEventListener('click',e=>{
  if(!e.target.classList.contains('view')) return;
  const l=loans[e.target.dataset.idx];
  openEMIModal(l);
});

function openEMIModal(l){
  document.getElementById('modalLoanId').innerText=l["Loan ID"];
  document.getElementById('modalName').innerText=l["Name"];
  const tbody=document.querySelector("#historyTable tbody");
  tbody.innerHTML='';
  const start=new Date(l.StartDate);
  const history=JSON.parse(l["EMI History"]||'[]');
  let outstanding=l.Principal;
  for(let i=0;i<l.Tenure;i++){
    const due=new Date(start); due.setMonth(start.getMonth()+i);
    const paid=history.filter(h=>h.type==="emi"&&new Date(h.date).getMonth()===due.getMonth()).reduce((a,h)=>a+h.amount,0);
    const penalty=history.filter(h=>h.type==="penalty"&&new Date(h.date).getMonth()===due.getMonth()).reduce((a,h)=>a+h.amount,0);
    outstanding = outstanding - paid + penalty;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td>
      <td>${due.toISOString().split('T')[0]}</td>
      <td>${rupee(l.EMI)}</td>
      <td>${rupee(paid)}</td>
      <td>${rupee(penalty)}</td>
      <td>${rupee(outstanding>0?outstanding.toFixed(0):0)}</td>`;
    tbody.appendChild(tr);
  }
  document.getElementById('historyModal').style.display='flex';
}

function closeModal(){document.getElementById('historyModal').style.display='none'}

document.getElementById('search').addEventListener('input',e=>refreshList(e.target.value));
document.getElementById('calcBtn').addEventListener('click',()=>{
  const P=document.getElementById('principal').value||0;
  const r=document.getElementById('rate').value||0;
  const n=document.getElementById('tenure').value||0;
  const emi=calcEMI(P,r,n);
  document.getElementById('emiResult').innerText=emi? rupee(emi.toFixed(0)):'—';
});
document.getElementById('addLoan').addEventListener('click',async ()=>{
  const loanId=document.getElementById('loanId').value.trim();
  const name=document.getElementById('name').value.trim();
  const account=document.getElementById('account').value.trim();
  const principal=Number(document.getElementById('principal').value||0);
  const rate=Number(document.getElementById('rate').value||0);
  const tenure=Number(document.getElementById('tenure').value||0);
  if(!loanId||!name||!account||principal<=0){alert('Loan ID, Name, Account, Principal required');return;}
  const emi=calcEMI(principal,rate,tenure).toFixed(0);
  const startDate=new Date().toISOString().split('T')[0];
  await fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"addLoan",loanId,name,account,principal,rate,tenure,emi,startDate})});
  alert("Loan saved successfully!"); document.getElementById('loanForm').reset(); document.getElementById('emiResult').innerText='—'; fetchLoans();
});
document.getElementById('payEmi').addEventListener('click',async ()=>{
  const loanId=document.getElementById('emiLoanId').value.trim();
  const amount=Number(document.getElementById('emiAmount').value||0);
  const date=document.getElementById('emiDate').value;
  if(!loanId||amount<=0){alert("Valid Loan ID and Amount required"); return;}
  await fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"payEmi",loanId,amount,date})});
  alert("EMI updated successfully"); document.getElementById('emiForm').reset(); fetchLoans();
});
document.getElementById('addPenalty').addEventListener('click',async ()=>{
  const loanId=document.getElementById('penaltyLoanId').value.trim();
  const amount=Number(document.getElementById('penaltyAmount').value||0);
  const date=document.getElementById('penaltyDate').value;
  if(!loanId||amount<=0){alert("Valid Loan ID and Penalty required"); return;}
  await fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"addPenalty",loanId,amount,date})});
  alert("Penalty added successfully"); document.getElementById('penaltyForm').reset(); fetchLoans();
});

fetchLoans();
</script>
</body>
</html>
