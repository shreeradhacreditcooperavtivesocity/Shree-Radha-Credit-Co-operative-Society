<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loan Dashboard — Shree Radha Credit Co-operative Society</title>
<style>
:root{--maroon:#800000;--light:#a55252;--paper:#fff;--muted:#666}
*{box-sizing:border-box}
body{font-family:Inter, system-ui, Arial; margin:0; background:#f6f7fb; color:#222}
header{background:linear-gradient(90deg,var(--maroon),var(--light)); color:white; padding:18px 20px}
.wrap{max-width:1100px;margin:18px auto;padding:18px}
.grid{display:grid;gap:16px}
.cols-3{grid-template-columns:1fr 420px;}
.card{background:var(--paper);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding:16px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
button{background:var(--maroon);color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
.muted{color:var(--muted);font-size:13px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left;font-size:14px}
th{background:#fafafa}
.top-actions{display:flex;gap:8px;align-items:center}
.summary{display:flex;gap:12px;flex-wrap:wrap}
.sum-card{background:#fff;padding:12px;border-radius:8px;min-width:140px;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:8px;max-width:800px;width:90%;max-height:80%;overflow:auto;position:relative}
.modal-close{position:absolute;top:8px;right:12px;font-size:20px;font-weight:bold;cursor:pointer}
@media(max-width:900px){.cols-3{grid-template-columns:1fr} .wrap{padding:12px}}
@media print{body *{visibility:hidden} .print-area, .print-area *{visibility:visible} .print-area{position:fixed;left:0;top:0;width:100%}}
.note-hi{font-weight:600;margin-top:8px;color:#800000}
</style>
</head>
<body>
<header>
  <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1 style="margin:0;font-size:18px">Shree Radha Credit Co-operative Society</h1>
      <div style="font-size:13px;opacity:0.95">Loan Dashboard — Reg. No: DR/DHR/151716</div>
    </div>
    <div style="font-size:13px;opacity:0.95">मेन्यू: Loan Register · Loan List · Reports</div>
  </div>
</header>

<main class="wrap">
<section class="grid cols-3">

  <!-- Loan List -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 style="margin:0;font-size:16px">Loan Register & List</h2>
      <div class="top-actions">
        <input id="search" placeholder="खोज: नाम / खाता नंबर / लोन आईडी" style="width:250px;padding:8px;border-radius:8px;border:1px solid #ddd" />
      </div>
    </div>
    <div class="summary" id="summary">
      <div class="sum-card"><div class="muted">कुल लोन</div><div id="totalLoans">0</div></div>
      <div class="sum-card"><div class="muted">कुल मूलधन</div><div id="totalPrincipal">₹0</div></div>
      <div class="sum-card"><div class="muted">कुल बकाया</div><div id="totalOutstanding">₹0</div></div>
    </div>
    <div style="margin-top:12px;max-height:420px;overflow:auto">
      <table>
        <thead>
          <tr><th>Loan ID</th><th>Name</th><th>Account</th><th>Principal</th><th>Rate%</th><th>Tenure</th><th>EMI</th><th>Paid EMI</th><th>Penalty</th><th>Outstanding</th><th>Action</th></tr>
        </thead>
        <tbody id="loansTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Forms Sidebar -->
  <aside>

    <!-- Add / Update Loan -->
    <div class="card">
      <h3>नया लोन दर्ज करें</h3>
      <form id="loanForm" onsubmit="return false">
        <label>Loan ID</label><input id="loanId" required />
        <label>नाम</label><input id="name" required />
        <label>खाता नंबर</label><input id="account" required />
        <label>लोन राशि (₹)</label><input id="principal" type="number" min="0" required />
        <label>सालाना ब्याज दर (%)</label><input id="rate" type="number" step="0.01" min="0" value="12" required />
        <label>अवधि (महीनों में)</label><input id="tenure" type="number" min="1" value="12" required />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="calcBtn" type="button">EMI Calculate</button>
          <button id="addLoan" type="button">Add/Update Loan</button>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Calculated EMI</div>
          <div id="emiResult" style="font-weight:700;font-size:16px">—</div>
        </div>
      </form>
    </div>

    <!-- EMI Payment Form -->
    <div class="card">
      <h3>EMI Payment</h3>
      <form id="emiForm" onsubmit="return false">
        <label>Loan ID</label><input id="emiLoanId" required />
        <label>Paid EMI (₹)</label><input id="emiAmount" type="number" min="0" required />
        <label>Payment Date</label><input id="emiDate" type="date" value="" required />
        <button id="payEmi" type="button">Submit EMI Payment</button>
      </form>
    </div>

    <!-- Penalty Form -->
    <div class="card">
      <h3>Penalty Entry</h3>
      <form id="penaltyForm" onsubmit="return false">
        <label>Loan ID</label><input id="penaltyLoanId" required />
        <label>Penalty (₹)</label><input id="penaltyAmount" type="number" min="0" required />
        <label>Payment Date</label><input id="penaltyDate" type="date" value="" required />
        <button id="addPenalty" type="button">Add Penalty</button>
      </form>
    </div>

  </aside>
</section>
</main>

<!-- EMI History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">×</span>
    <h3>EMI History & Schedule</h3>
    <table id="historyTable" style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th>Month</th>
          <th>Due Date</th>
          <th>EMI Amount (₹)</th>
          <th>Paid (₹)</th>
          <th>Penalty (₹)</th>
          <th>Outstanding (₹)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzOWl9VGWnCHB9aOJOXJ87wFWsr81StNSqKo0F0z79MkxEmwdT2JZCc2RebraLQ5RqtHg/exec"; // Replace with your deployed Apps Script URL
let loans=[];

function rupee(x){return '₹'+Number(x).toLocaleString('en-IN')}
function calcEMI(P,r,n){P=Number(P);r=Number(r)/100/12;n=Number(n);return r===0? P/n: (P*r*Math.pow(1+r,n))/(Math.pow(1+r,n)-1)}

// Fetch Loans
async function fetchLoans(){
  try{
    const res = await fetch(WEB_APP_URL+'?action=getLoans');
    const data = await res.json();
    loans = data.map(l=>{
      l["Principal"]=Number(l["Principal"]);
      l["Rate"]=Number(l["Rate"]);
      l["Tenure"]=Number(l["Tenure"]);
      l["EMI"]=Number(l["EMI"]);
      l["Paid EMI"]=Number(l["Paid EMI"]||0);
      l["Penalty"]=Number(l["Penalty"]||0);
      l["Outstanding"]=Number(l["Outstanding"]||0);
      l["EMI History"]=l["EMI History"] || '[]';
      l["StartDate"]=l["StartDate"] || new Date().toISOString().split('T')[0];
      return l;
    });
    refreshList();
  }catch(err){console.error(err);}
}

// Refresh Loan Table
function refreshList(filter=''){
  const tbody=document.getElementById('loansTbody'); 
  tbody.innerHTML='';
  let totalP=0,totalOutstanding=0;
  const q=filter.trim().toLowerCase();
  loans.forEach((l,idx)=>{
    const rowText=[l["Loan ID"],l["Name"],l["Account"]].join(' ').toLowerCase();
    if(q && !rowText.includes(q)) return;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${l["Loan ID"]}</td>
      <td>${l["Name"]}</td>
      <td>${l["Account"]}</td>
      <td>${rupee(l["Principal"])}</td>
      <td>${l["Rate"]}</td>
      <td>${l["Tenure"]}</td>
      <td>${rupee(l["EMI"].toFixed(0))}</td>
      <td>${rupee(l["Paid EMI"])}</td>
      <td>${rupee(l["Penalty"])}</td>
      <td>${rupee(l["Outstanding"])}</td>
      <td><button data-idx="${idx}" class="view">View</button></td>`;
    tbody.appendChild(tr);
    totalP+=l["Principal"];
    totalOutstanding+=l["Outstanding"];
  });
  document.getElementById('totalLoans').innerText=loans.length;
  document.getElementById('totalPrincipal').innerText=rupee(totalP);
  document.getElementById('totalOutstanding').innerText=rupee(totalOutstanding);
}

// EMI Calculate
document.getElementById('calcBtn').addEventListener('click',()=>{
  const P=document.getElementById('principal').value||0;
  const r=document.getElementById('rate').value||0;
  const n=document.getElementById('tenure').value||0;
  const emi=calcEMI(P,r,n);
  document.getElementById('emiResult').innerText=emi? rupee(emi.toFixed(0)):'—';
});

// Add / Update Loan
document.getElementById('addLoan').addEventListener('click', async ()=>{
  const loanId=document.getElementById('loanId').value.trim();
  const name=document.getElementById('name').value.trim();
  const account=document.getElementById('account').value.trim();
  const principal=Number(document.getElementById('principal').value||0);
  const rate=Number(document.getElementById('rate').value||0);
  const tenure=Number(document.getElementById('tenure').value||0);
  if(!loanId||!name||!account||principal<=0){alert('Loan ID, Name, Account, Principal required');return;}
  const emi=calcEMI(principal,rate,tenure).toFixed(0);
  const startDate=new Date().toISOString().split('T')[0];
  try{
    await fetch(WEB_APP_URL,{
      method:"POST",
      body: JSON.stringify({action:"addLoan",loanId,name,account,principal,rate,tenure,emi,startDate})
    });
    alert("Loan saved successfully!");
    document.getElementById('loanForm').reset();
    document.getElementById('emiResult').innerText='—';
    fetchLoans();
  }catch(err){console.error(err);}
});

// EMI Payment
document.getElementById('payEmi').addEventListener('click', async ()=>{
  const loanId=document.getElementById('emiLoanId').value.trim();
  const amount=Number(document.getElementById('emiAmount').value||0);
  const date=document.getElementById('emiDate').value;
  if(!loanId||amount<=0){alert("Valid Loan ID and Amount required"); return;}
  try{
    await fetch(WEB_APP_URL,{
      method:"POST",
      body: JSON.stringify({action:"payEmi",loanId,amount,date})
    });
    alert("EMI updated successfully");
    document.getElementById('emiForm').reset();
    fetchLoans();
  }catch(err){console.error(err);}
});

// Penalty Entry
document.getElementById('addPenalty').addEventListener('click', async ()=>{
  const loanId=document.getElementById('penaltyLoanId').value.trim();
  const amount=Number(document.getElementById('penaltyAmount').value||0);
  const date=document.getElementById('penaltyDate').value;
  if(!loanId||amount<=0){alert("Valid Loan ID and Penalty required"); return;}
  try{
    await fetch(WEB_APP_URL,{
      method:"POST",
      body: JSON.stringify({action:"addPenalty",loanId,amount,date})
    });
    alert("Penalty added successfully");
    document.getElementById('penaltyForm').reset();
    fetchLoans();
  }catch(err){console.error(err);}
});

// Search & View EMI History
document.getElementById('search').addEventListener('input',(e)=>refreshList(e.target.value));

document.getElementById('loansTbody').addEventListener('click',(e)=>{
  if(e.target.classList.contains('view')){
    const l=loans[e.target.dataset.idx];
    const history=JSON.parse(l["EMI History"]||'[]');
    const tbody=document.querySelector("#historyTable tbody");
    tbody.innerHTML='';
    const startDate=new Date(l["StartDate"]);
    let outstanding=l["Principal"];
    for(let i=0;i<l["Tenure"];i++){
      const monthDate=new Date(startDate);
      monthDate.setMonth(startDate.getMonth()+i);

      const paid=history.filter(h=>h.type==="emi" &&
          new Date(h.date).getMonth()===monthDate.getMonth() &&
          new Date(h.date).getFullYear()===monthDate.getFullYear())
          .reduce((a,h)=>a+h.amount,0);

      const penaltyMonth=history.filter(h=>h.type==="penalty" &&
          new Date(h.date).getMonth()===monthDate.getMonth() &&
          new Date(h.date).getFullYear()===monthDate.getFullYear())
          .reduce((a,h)=>a+h.amount,0);

      outstanding = outstanding - paid + penaltyMonth;

      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td>
        <td>${monthDate.toISOString().split('T')[0]}</td>
        <td>${rupee(l["EMI"])}</td>
        <td>${rupee(paid)}</td>
        <td>${rupee(penaltyMonth)}</td>
        <td>${rupee(outstanding>0?outstanding.toFixed(0):0)}</td>`;
      tbody.appendChild(tr);
    }
    openModal();
  }
});

// Modal
function openModal(){document.getElementById('historyModal').style.display='flex'}
function closeModal(){document.getElementById('historyModal').style.display='none'}

// Initial fetch
fetchLoans();
</script>
</body>
</html>
